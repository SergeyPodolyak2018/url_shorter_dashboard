const urlService = require('../services/urlService');
const rateService = require('../services/rateService');
const MESSAGE = require('../helper/messages');
const Logger = require('../logger.js');
const log = new Logger('urlController.js');

const checkId = (req, res, next, id) => {
  const someId = id || req.params.id;
  res.locals.shorts = someId;
  next();
};
const checkRate = async (req, res, next) => {
  let shortCode = res.locals.shorts;
  let userId = res.locals.decoded.id;
  const check = await rateService.checkRate(userId, shortCode);
  if (check) {
    await rateService.incrementURLRate(shortCode);
    await rateService.incrementUserRate(userId);
    return next();
  } else {
    const massage = MESSAGE.TO_MANY_REQUEST();
    res.status(massage.status);
    res.render('./pages/rate.ejs');
    return;
  }
};

const getCode = async (req, res) => {
  let shortCode = res.locals.shorts;
  const code = await urlService.getUrlByName(shortCode);
  res.redirect(code[0].url);
};

module.exports = { getCode, checkId, checkRate };
